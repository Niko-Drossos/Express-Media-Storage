<!-- Import cropper for updating avatar image -->
<head>
  <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
</head>

<div class="divide-y divide-white/5">
  <div class="grid max-w-7xl grid-cols-1 gap-x-8 gap-y-10 px-4 py-16 sm:px-6 md:grid-cols-3 lg:px-8">
    <div>
      <h2 class="text-base/7 font-semibold text-black">Personal Information</h2>
      <p class="mt-1 text-sm/6 text-gray-400">Use a permanent address where you can receive mail.</p>
    </div>

    <form class="md:col-span-2">
      <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:max-w-xl sm:grid-cols-6">
        <div class="col-span-full flex items-center gap-x-8">
          <!-- <img src="/stream/image/<%= user.avatarId %>" alt="" class="size-24 flex-none rounded-lg bg-gray-800 object-cover"> -->
          <span class="relative inline-block">
            <img class="size-28 rounded-full ring-1" src="/stream/image/<%= user.avatarId %>" alt="">
          </span>
          <div>
            <button type="button" data-avatar-trigger class="rounded-md bg-white/10 px-3 py-2 text-sm font-semibold text-black shadow-xs hover:bg-white/20">Change avatar</button>
            <p class="mt-2 text-xs/5 text-gray-400">JPG, GIF or PNG. 1MB max.</p>
          </div>
        </div>
        <!-- Hidden File Input -->


      <!-- <button type="button" data-avatar-trigger class="rounded-md bg-white/10 px-3 py-2 text-sm font-semibold text-black shadow-xs hover:bg-white/20">
        Change avatar
      </button> -->



        <div class="sm:col-span-3">
          <label for="first-name" class="block text-sm/6 font-medium text-black">First name</label>
          <div class="mt-2">
            <input type="text" name="first-name" id="first-name" autocomplete="given-name" class="block w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black outline-1 -outline-offset-1 outline-white/10 placeholder:text-gray-500 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6">
          </div>
        </div>

        <div class="sm:col-span-3">
          <label for="last-name" class="block text-sm/6 font-medium text-black">Last name</label>
          <div class="mt-2">
            <input type="text" name="last-name" id="last-name" autocomplete="family-name" class="block w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black outline-1 -outline-offset-1 outline-white/10 placeholder:text-gray-500 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6">
          </div>
        </div>

        <div class="col-span-full">
          <label for="email" class="block text-sm/6 font-medium text-black">Email address</label>
          <div class="mt-2">
            <input id="email" name="email" type="email" autocomplete="email" class="block w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black outline-1 -outline-offset-1 outline-white/10 placeholder:text-gray-500 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6">
          </div>
        </div>

        <div class="col-span-full">
          <label for="username" class="block text-sm/6 font-medium text-black">Username</label>
          <div class="mt-2">
            <div class="flex items-center rounded-md bg-white/5 pl-3 outline-1 -outline-offset-1 outline-white/10 focus-within:outline-2 focus-within:-outline-offset-2 focus-within:outline-indigo-500">
              <div class="shrink-0 text-base text-gray-500 select-none sm:text-sm/6">example.com/</div>
              <input type="text" name="username" id="username" class="block min-w-0 grow bg-transparent py-1.5 pr-3 pl-1 text-base text-black placeholder:text-gray-500 focus:outline-none sm:text-sm/6" placeholder="janesmith">
            </div>
          </div>
        </div>

        <div class="col-span-full">
          <label for="timezone" class="block text-sm/6 font-medium text-black">Timezone</label>
          <div class="mt-2 grid grid-cols-1">
            <select id="timezone" name="timezone" class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white/5 py-1.5 pr-8 pl-3 text-base text-black outline-1 -outline-offset-1 outline-white/10 *:bg-gray-800 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6">
              <option>Pacific Standard Time</option>
              <option>Eastern Standard Time</option>
              <option>Greenwich Mean Time</option>
            </select>
            <svg class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-400 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" data-slot="icon">
              <path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
          </div>
        </div>
      </div>

      <div class="mt-8 flex">
        <button type="submit" class="rounded-md bg-indigo-500 px-3 py-2 text-sm font-semibold text-black shadow-xs hover:bg-indigo-400 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">Save</button>
      </div>
    </form>
  </div>

  <div class="grid max-w-7xl grid-cols-1 gap-x-8 gap-y-10 px-4 py-16 sm:px-6 md:grid-cols-3 lg:px-8">
    <div>
      <h2 class="text-base/7 font-semibold text-black">Change password</h2>
      <p class="mt-1 text-sm/6 text-gray-400">Update your password associated with your account.</p>
    </div>

    <form class="md:col-span-2">
      <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:max-w-xl sm:grid-cols-6">
        <div class="col-span-full">
          <label for="current-password" class="block text-sm/6 font-medium text-black">Current password</label>
          <div class="mt-2">
            <input id="current-password" name="current_password" type="password" autocomplete="current-password" class="block w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black outline-1 -outline-offset-1 outline-white/10 placeholder:text-gray-500 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6">
          </div>
        </div>

        <div class="col-span-full">
          <label for="new-password" class="block text-sm/6 font-medium text-black">New password</label>
          <div class="mt-2">
            <input id="new-password" name="new_password" type="password" autocomplete="new-password" class="block w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black outline-1 -outline-offset-1 outline-white/10 placeholder:text-gray-500 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6">
          </div>
        </div>

        <div class="col-span-full">
          <label for="confirm-password" class="block text-sm/6 font-medium text-black">Confirm password</label>
          <div class="mt-2">
            <input id="confirm-password" name="confirm_password" type="password" autocomplete="new-password" class="block w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black outline-1 -outline-offset-1 outline-white/10 placeholder:text-gray-500 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6">
          </div>
        </div>
      </div>

      <div class="mt-8 flex">
        <button type="submit" class="rounded-md bg-indigo-500 px-3 py-2 text-sm font-semibold text-black shadow-xs hover:bg-indigo-400 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">Save</button>
      </div>
    </form>
  </div>

  <div class="grid max-w-7xl grid-cols-1 gap-x-8 gap-y-10 px-4 py-16 sm:px-6 md:grid-cols-3 lg:px-8">
    <div>
      <h2 class="text-base/7 font-semibold text-black">Log out other sessions</h2>
      <p class="mt-1 text-sm/6 text-gray-400">Please enter your password to confirm you would like to log out of your other sessions across all of your devices.</p>
    </div>

    <form class="md:col-span-2">
      <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:max-w-xl sm:grid-cols-6">
        <div class="col-span-full">
          <label for="logout-password" class="block text-sm/6 font-medium text-black">Your password</label>
          <div class="mt-2">
            <input id="logout-password" name="password" type="password" autocomplete="current-password" class="block w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black outline-1 -outline-offset-1 outline-white/10 placeholder:text-gray-500 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6">
          </div>
        </div>
      </div>

      <div class="mt-8 flex">
        <button type="submit" class="rounded-md bg-indigo-500 px-3 py-2 text-sm font-semibold text-black shadow-xs hover:bg-indigo-400 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">Log out other sessions</button>
      </div>
    </form>
  </div>

  <div class="grid max-w-7xl grid-cols-1 gap-x-8 gap-y-10 px-4 py-16 sm:px-6 md:grid-cols-3 lg:px-8">
    <div>
      <h2 class="text-base/7 font-semibold text-black">Delete account</h2>
      <p class="mt-1 text-sm/6 text-gray-400">No longer want to use our service? You can delete your account here. This action is not reversible. All information related to this account will be deleted permanently.</p>
    </div>
    <form class="flex items-start md:col-span-2">
      <button type="submit" class="rounded-md bg-red-500 px-3 py-2 text-sm font-semibold text-black shadow-xs hover:bg-red-400">Yes, delete my account</button>
    </form>
  </div>
</div>

<%- include('./partials/modals/success.ejs', { name: "update-avatar", cancelable: true, redirect: "/auth/login" }) %>

<!-- User avatar cropping modal -->
<input type="file" id="avatarInput" class="hidden" accept="image/*">

<!-- Modal -->
<div id="cropModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-lg p-4 max-w-md w-full">
    <div class="mb-4">
      <img id="cropImage" class="max-h-96 w-full object-contain">
    </div>
    <div class="flex justify-end gap-2">
      <button id="cancelCrop" class="px-3 py-1 rounded bg-gray-300 hover:bg-gray-400 text-black">Cancel</button>
      <button id="applyCrop" class="px-3 py-1 rounded bg-indigo-500 text-black hover:bg-indigo-400">Apply</button>
    </div>
  </div>
</div>


<!-- User Avatar updating logic -->
<script>
  const avatarInput = document.getElementById('avatarInput')
  const cropModal = document.getElementById('cropModal')
  const cropImage = document.getElementById('cropImage')
  const cancelBtn = document.getElementById('cancelCrop')
  const applyBtn = document.getElementById('applyCrop')

  let cropper

  document.querySelector('[data-avatar-trigger]').addEventListener('click', () => {
    avatarInput.click()
  })

  avatarInput.addEventListener('change', (e) => {
    const file = e.target.files[0]
    if (!file) return

    const reader = new FileReader()
    reader.onload = () => {
      cropImage.src = reader.result
      cropModal.classList.remove('hidden')
      cropper = new Cropper(cropImage, {
        aspectRatio: 1,
        viewMode: 1,
        minCropBoxWidth: 200,
        minCropBoxHeight: 200
      })
    }
    reader.readAsDataURL(file)
  })

  cancelBtn.addEventListener('click', () => {
    cropper.destroy()
    cropModal.classList.add('hidden')
  })

  applyBtn.addEventListener('click', () => {
    const canvas = cropper.getCroppedCanvas({
      width: 200,
      height: 200,
    })

    // Optional: convert to blob for FormData upload
    canvas.toBlob(blob => {
      const formData = new FormData()
      formData.append('avatar', blob, 'avatar.jpg')

      fetch('/user/profile/upload-avatar', {
        method: 'POST',
        body: formData
      })
      .then(() => showModal("update-avatar", "Avatar updated", "Please sign out and log back in to see the changes."))
    })

    cropper.destroy()
    cropModal.classList.add('hidden')
  })
</script>
